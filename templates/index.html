<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wordle with Sign Language Recognition</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #wordle-game {
            border: 2px solid #ddd;
            padding: 20px;
            height: 650px;
            overflow-y: auto;
            width: 360px; /* 固定宽度 */
            margin: 0 auto; /* 居中 */
        }

        #camera-section {
            padding: 20px;
            height: 650px;
            margin-bottom: 30px;
        }

        #result-display {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
            height: 150px;
        }

        video {
            width: 100%;
            height: auto;
        }

        .game-container {
            display: grid;
            grid-template-columns: repeat(5, 60px); /* 固定每个单元格宽度 */
            gap: 10px;
            justify-content: center; /* 中心对齐 */
        }

        .letter-box {
            width: 60px;
            height: 60px;
            border: 2px solid #ced4da;
            text-align: center;
            line-height: 60px;
            font-size: 24px;
            text-transform: uppercase;
            background-color: white;
            border-radius: 4px;
        }

        .correct {
            background-color: #28a745 !important;
            color: white !important;
        }

        .present {
            background-color: #ffc107 !important;
            color: white !important;
        }

        .absent {
            background-color: #6c757d !important;
            color: white !important;
        }

        #countdown {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="row">
            <!-- Wordle Game Section -->
            <div class="col-md-6" id="wordle-game">
                <h3 class="text-center">Wordle Game</h3>
                <div class="game-container" id="game-board"></div>
                <div id="message" class="mt-4 text-center"></div>
                <div id="answer-display" class="mt-2 text-center">Answer: <span id="answer"></span></div>
            </div>

            <!-- Camera and Recording Section -->
            <div class="col-md-6" id="camera-section">
                <h3>Camera & Recording</h3>
                <video id="camera" autoplay></video>
                <div id="countdown"></div>
                <button class="btn btn-primary" onclick="startRecording(3)">Record 3 seconds</button>
                <button class="btn btn-primary" onclick="startRecording(5)">Record 5 seconds</button>
                <button class="btn btn-primary" onclick="startRecording(10)">Record 10 seconds</button>
                <button class="btn btn-secondary mt-2" onclick="passInput()">Pass (Input 'A')</button>
                <button class="btn btn-danger mt-2" onclick="resetGame()">Reset Game</button>
                <div id="result-display">
                    <p id="recognized-word">Word: -</p>
                    <p id="confidence-level">Confidence: -</p>
                    <p id="base64-video">Base64 Video: -</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let WORDS = ["apple", "bread", "crane", "frame", "grape"];
        let answer = WORDS[Math.floor(Math.random() * WORDS.length)];
        const board = document.getElementById('game-board');
        const message = document.getElementById('message');
        let currentRow = 0;
        let currentGuess = "";

        function createBoard() {
            document.getElementById('answer').textContent = answer; // 初始化时显示答案
            board.innerHTML = '';  // 清空棋盘后再创建
            for (let i = 0; i < 30; i++) {
                const box = document.createElement('div');
                box.classList.add('letter-box');
                board.appendChild(box);
            }
        }

        function updateBoard() {
            const row = board.querySelectorAll(`.letter-box:nth-child(n+${currentRow * 5 + 1}):nth-child(-n+${currentRow * 5 + 5})`);
            row.forEach((box, i) => {
                box.textContent = currentGuess[i] || '';
            });
        }

        function checkGuess() {
            const row = board.querySelectorAll(`.letter-box:nth-child(n+${currentRow * 5 + 1}):nth-child(-n+${currentRow * 5 + 5})`);
            const guess = currentGuess;
            const answerArray = answer.split('');

            row.forEach((box, i) => {
                if (answerArray[i] === guess[i]) {
                    box.classList.add('correct');
                    answerArray[i] = null;
                } else if (answerArray.includes(guess[i])) {
                    box.classList.add('present');
                    answerArray[answerArray.indexOf(guess[i])] = null;
                } else {
                    box.classList.add('absent');
                }
            });

            if (guess === answer) {
                message.textContent = 'You guessed it! Well done!';
            } else if (currentRow === 5) {
                message.textContent = `Game over! The word was ${answer}.`;
            } else {
                currentRow++;
                currentGuess = '';
            }
        }

        function resetGame() {
            answer = WORDS[Math.floor(Math.random() * WORDS.length)];
            document.getElementById('answer').textContent = answer; // 重置游戏时显示答案
            currentRow = 0;
            currentGuess = '';
            message.textContent = '';
            createBoard();
        }

        createBoard();

        let camera = document.getElementById('camera');
        let countdownElement = document.getElementById('countdown');
        let recognizedWordElement = document.getElementById('recognized-word');
        let confidenceLevelElement = document.getElementById('confidence-level');
        let base64VideoElement = document.getElementById('base64-video');
        let mediaRecorder;
        let chunks = [];

        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                camera.srcObject = stream;
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = event => {
                    chunks.push(event.data);
                };
                mediaRecorder.onstop = processRecording;
            })
            .catch(error => {
                console.error("Error accessing camera: ", error);
            });

        function startRecording(duration) {
            let remainingTime = duration;
            countdownElement.innerText = `Recording starts in: ${remainingTime}s`;

            let countdown = setInterval(() => {
                remainingTime--;
                countdownElement.innerText = `Recording starts in: ${remainingTime}s`;

                if (remainingTime <= 0) {
                    clearInterval(countdown);
                    countdownElement.innerText = "Recording...";
                    mediaRecorder.start();
                    setTimeout(() => {
                        mediaRecorder.stop();
                        countdownElement.innerText = "Recording complete!";
                    }, duration * 1000);
                }
            }, 1000);
        }

        function sendVideoToAPI(base64Video) {
            const postData = {
                Authorization: "your_auth_token", // 替換為實際的授權碼
                file: base64Video,
                mode: "your_mode" // 替換為實際的模式
            };

            fetch('http://127.0.0.1:8000/upload/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(postData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                if (data.status === 'success') {
                    const confidencePercentage = (parseFloat(data.data.confidence) * 100).toFixed(2) + '%';
                    recognizedWordElement.innerText = `Word: ${data.data.recognizedWord}`;
                    confidenceLevelElement.innerText = `Confidence: ${confidencePercentage}`;

                    // 将结果作为一个字母输入到Wordle游戏中
                    if (data.data.recognizedWord.length === 1) {
                        currentGuess += data.data.recognizedWord.toLowerCase();
                        updateBoard();

                        if (currentGuess.length === 5) {
                            checkGuess();
                        }
                    }
                } else {
                    recognizedWordElement.textContent = data.feedback || "Recognition failed.";
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                recognizedWordElement.textContent = "Error during recognition.";
            });
        }

        function processRecording() {
            let blob = new Blob(chunks, { type: 'video/webm' });
            chunks = [];
            let reader = new FileReader();
            reader.onloadend = function() {
                let base64Video = reader.result.split(',')[1];
                base64VideoElement.innerText = `Base64 Video: ${base64Video}`;
                // 可以在此處進行進一步處理，比如傳送到後端進行手語辨識
                sendVideoToAPI(base64Video);
            };
            reader.readAsDataURL(blob);
        }

        function passInput() {
            currentGuess += 'a';
            updateBoard();
            if (currentGuess.length === 5) {
                checkGuess();
            }
        }
    </script>
</body>

</html>
